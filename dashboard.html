<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/dashboard.css') }}"
    />
  </head>
  <body>
    <!-- Logout button -->
    <form
      action="/logout"
      method="post"
      style="position: absolute; top: 20px; right: 200px"
    >
      <button type="submit" class="toggle-btn">Logout</button>
    </form>

    <!-- Dark mode toggle button -->
    <button
      id="toggle-btn"
      class="toggle-btn"
      style="position: absolute; top: 20px; right: 20px"
    >
      Dark Mode
    </button>

    <div class="container">
      <!-- Light grey side ribbon with logo -->
      <div class="side-ribbon">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      </div>

      <!-- Main content area -->
      <div class="main-content">
        <div class="main-title">
          <h1>Test Data Generator (LLM)</h1>
        </div>

        <!-- File Upload Form -->
        <label for="jsonFile" class="file-label"
          >Select a JSON file (required):</label
        >
        <input type="file" id="jsonFile" accept=".json" required />

        <label for="xlsxFile" class="file-label"
          >Select an optional XLSX file:</label
        >
        <input type="file" id="xlsxFile" accept=".xlsx" />

        <button id="upload-btn" class="upload-btn">Upload</button>

        <!-- Loading bar (hidden initially) -->
        <div id="loading-bar" class="loading-bar" style="display: none">
          <p>Test Data Generation in Progress...</p>
          <div class="progress-bar">
            <div class="progress"></div>
          </div>
        </div>

        <!-- Output Container (hidden initially) -->
        <div
          id="output-container"
          class="output-container"
          style="display: none"
        >
          <h2>Generated Output:</h2>
          <div id="output-box" class="output-box"></div>

          <!-- Download JSON button (hidden initially) -->
          <button
            id="download-json-btn"
            class="download-btn"
            style="display: none"
          >
            Download as JSON
          </button>
        </div>
      </div>
    </div>

    <!-- Script to handle file upload -->
    <script>
      document
        .getElementById("upload-btn")
        .addEventListener("click", function () {
          const jsonFile = document.getElementById("jsonFile").files[0];
          const xlsxFile = document.getElementById("xlsxFile").files[0];

          if (!jsonFile) {
            alert("Please select a JSON file (required)!");
            return;
          }

          const formData = new FormData();
          formData.append("jsonFile", jsonFile);

          if (xlsxFile) {
            formData.append("xlsxFile", xlsxFile);
          }

          // Show loading bar
          const loadingBar = document.getElementById("loading-bar");
          loadingBar.style.display = "block";

          // Make the API call
          fetch("/process-files", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              // Hide the loading bar
              loadingBar.style.display = "none";

              // Show the output
              const outputContainer =
                document.getElementById("output-container");
              const outputBox = document.getElementById("output-box");
              const downloadJsonBtn =
                document.getElementById("download-json-btn");

              outputContainer.style.display = "block";
              outputBox.innerHTML =
                "<pre>" + JSON.stringify(data, null, 4) + "</pre>";

              // Show the download button
              downloadJsonBtn.style.display = "block";

              // Set up the JSON download button functionality
              downloadJsonBtn.addEventListener("click", function () {
                const jsonBlob = new Blob([JSON.stringify(data, null, 4)], {
                  type: "application/json",
                });
                const downloadUrl = URL.createObjectURL(jsonBlob);

                // Create a temporary link and trigger download
                const tempLink = document.createElement("a");
                tempLink.href = downloadUrl;
                tempLink.download = "generated_output.json";
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
              });
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while processing the files.");
              loadingBar.style.display = "none";
            });
        });

      // Dark mode toggle functionality
      const toggleBtn = document.getElementById("toggle-btn");
      const body = document.body;

      // Check saved mode on page load
      const savedMode = localStorage.getItem("mode");
      if (savedMode === "dark") {
        body.classList.add("dark-mode");
        toggleBtn.innerText = "Light Mode";
      }

      toggleBtn.addEventListener("click", function () {
        body.classList.toggle("dark-mode");
        const currentMode = body.classList.contains("dark-mode")
          ? "dark"
          : "light";
        toggleBtn.innerText =
          currentMode === "dark" ? "Light Mode" : "Dark Mode";
        localStorage.setItem("mode", currentMode);
      });
    </script>
  </body>
</html>
